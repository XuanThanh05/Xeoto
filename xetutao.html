<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <title>Mô hình xe 3D</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        #controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            color: white;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #45a049;
        }
        #info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: white;
            font-size: 14px;
        }
        #status {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            color: white;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="controls">
            <h3>Điều khiển xe</h3>
            <button onclick="toggleDoorUpperLeft()">Mở/Đóng cửa xe trên trái</button>
            <button onclick="toggleDoorUpperRight()">Mở/Đóng cửa xe trên phải</button>
            <button onclick="toggleDoorLowerLeft()">Mở/Đóng cửa xe dưới trái</button>
            <button onclick="toggleDoorLowerRight()">Mở/Đóng cửa xe dưới phải</button>
            <button onclick="toggleAllDoors()">Mở/Đóng tất cả cửa</button>
            <button onclick="TurnOnOffLight()">Bật/tắt đèn xe</button>
            <button onclick="TurnOnOffSun()">Bật/tắt Ánh sáng mặt trời</button>

            <button onclick="changeView()">Đổi góc nhìn</button>
        </div>
        <div id="info">
            <p>Kéo chuột để xoay | Cuộn chuột để zoom </p>
        </div>
        <div id="status">
            <p><strong>Trạng thái xe:</strong></p>
            <p>Vô lăng: <span id="steeringAngle">0</span></p>
            <p>Vận tốc: <span id="velocity">0</span></p>
            <p>Tiến: <span id="forward">false</span> | Lùi: <span id="backward">false</span></p>
            <p>Rẽ trái: <span id="left">false</span> | Rẽ phải: <span id="right">false</span></p>
        </div>

    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        let scene, camera, renderer, car;
        let doorUpperLeftOpen = false;
        let doorUpperRightOpen = false;
        let doorLowerLeftOpen = false;
        let doorLowerRightOpen = false;
        let mouseX = 0, mouseY = 0;
        let isMouseDown = false;

        // Biến toàn cục theo dõi trạng thái bật/tắt ánh sáng
        let sunon = true; // Đầu tiên ánh sáng bật
        let ambientLight, directionalLight; 
        //góc nhìn
        let isThirdPerson = true;
        //khác
        let steeringGroup;
        let helperLeft;
        let helperRight;
        // thông số liên quan đến điều khiển xe
        const maxSteeringAngle = THREE.MathUtils.degToRad(120); // +/- 120 độ
        let steeringAngle = 0; // góc vô lăng hiện tại
        let velocity = 0;
        const maxSpeed = 0.3;
        const acceleration = 0.002;
        const deceleration = 0.001;
        let moveForward = false;
        let moveBackward = false;
        let turnLeft = false;
        let turnRight = false;
        let wheelRotation = 0; // tổng số vòng quay của bánh (tích lũy)
        


        function init() {
            // Tạo scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);

            // Tạo camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 8, -10);//góc nhìn thứ3
            camera.lookAt(0, 0, 0);

            // Tạo renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.getElementById('container').appendChild(renderer.domElement);

            //Tạo ánh sáng
            ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);

            directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(8, 8, 10);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 1024;
            directionalLight.shadow.mapSize.height = 1024;
            scene.add(directionalLight);

            // Tạo sàn
            const floorGeometry = new THREE.PlaneGeometry(200, 200);
            const floorMaterial = new THREE.MeshLambertMaterial({ color: 0x808080 });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = -Math.PI / 2;
            floor.position.y = 0;
            floor.receiveShadow = true;
            scene.add(floor);

            // Tạo xe
            createCar();
            car.add(camera); // gắn camera vào xe

            // Tạo hệ trục tọa độ với chiều dài mỗi trục là 5 đơn vị
            const axesHelper = new THREE.AxesHelper(5);
            scene.add(axesHelper);

            helperLeft = new THREE.SpotLightHelper(frontLightLeft);
            helperRight = new THREE.SpotLightHelper(frontLightRight);
            scene.add(helperLeft);
            scene.add(helperRight);

            const pointLightHelper = new THREE.PointLightHelper(mornitorLight, 1); // 1 là kích thước sphere
            scene.add(pointLightHelper);
            // Thêm event listeners
            addEventListeners();

            // Bắt đầu animation loop
            animate();
        }
        function setFirstPersonView() {
            camera.position.set(0.5, 3.5, 0.5);       
            camera.lookAt(0.5, 3, 5);             
        }

        function setThirdPersonView() {
            camera.position.set(0, 8, -10);        
            camera.lookAt(0, 0, 0);               
        }


        function createCar() {
            car = new THREE.Group();

            // Tạo thân xe chính
            const bodyGeometry = new THREE.BoxGeometry(5, 0.1,10);
            const bodyMaterial = new THREE.MeshPhongMaterial({ color: 0x0066cc });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.position.y = 1;
            body.castShadow = true;
            body.receiveShadow = true;
            car.add(body);

            // Tạo headcabin (phần đầu xe)
            const cabinshape = new THREE.BoxGeometry(5, 1.5, 3.6);
            const headcabin = new THREE.Mesh(cabinshape, bodyMaterial);
            headcabin.position.set(0, 1.7, 4.6);
            headcabin.castShadow = true;
            headcabin.receiveShadow = true;
            car.add(headcabin);
            // ====== Tạo gương chiếu hậu trái ======
            const mirrorGeometry = new THREE.BoxGeometry(0.6, 0.3, 0.1);
            const mirrorMaterial = new THREE.MeshPhongMaterial({ color: 0x333333 });
            const leftMirror = new THREE.Mesh(mirrorGeometry, mirrorMaterial);
            leftMirror.position.set(2.8, 2.3, 3);  // bên trái đầu xe
            leftMirror.castShadow = true;
            leftMirror.receiveShadow = true;
            car.add(leftMirror);
            // ====== Tạo gương chiếu hậu phải ======
            const rightMirror = new THREE.Mesh(mirrorGeometry, mirrorMaterial);
            rightMirror.position.set(-2.8, 2.3, 3);  // bên phải đầu xe
            rightMirror.castShadow = true;
            rightMirror.receiveShadow = true;
            car.add(rightMirror);
            // Tạo tailcabin (phần đuôi xe)
            const tailcabin = new THREE.Mesh(cabinshape, bodyMaterial);
            tailcabin.position.set(0, 1.7, -4);
            tailcabin.castShadow = true;
            tailcabin.receiveShadow = true;
            car.add(tailcabin);
            // Tạo trần xe (có thể mở)
            // test();
            createkhungxe();
            // Tạo cửa xe
            createDoors();

            // Tạo bánh xe
            createWheels();

            // Tạo đèn pha
            createHeadlights();

            // Tạo nội thất
            createInterior();

            // Tạo kính chắn gió
            createWindshield();

            createLicencePlate();
            scene.add(car);
            // car.position.x=10;
        }
//         function test(){
            

//             const coneGeo = new THREE.ConeGeometry(1, 2, 32);
//             const coneMat = new THREE.MeshNormalMaterial();
//             const cone = new THREE.Mesh(coneGeo, coneMat);
//             cone.add(new THREE.AxesHelper(1));    
//             cone.position.set(-1,2,0); // nửa chiều cao
// // nửa chiều cao
//             scene.add(cone);

// const pivot = new THREE.Object3D();
//             pivot.add(cone);
//             pivot.position.set(0,1,0);
//             // pivot.rotation.x = Math.PI / 4;
//             scene.add(pivot);
//             pivot.add(new THREE.AxesHelper(2.5));    // Trục local của pivot
            
            

//             // // Xoay quanh đỉnh (pivot)
            

//         }
        function createkhungxe(){
             const khungxeGroup = new THREE.Group();
             //thanh chéo đầu xe

             //thanh giữa xe

             //thanh đuôi xe
        }
        let leftUpperDoorGroup, rightUpperDoorGroup;
        let leftLowerDoorGroup, rightLowerDoorGroup;

        function createDoors() {
            const doorGroup = new THREE.Group();
            const doorMaterial = new THREE.MeshPhongMaterial({ color: 0x0066cc });
            const thanhdoorMaterial = new THREE.MeshPhongMaterial({ color: 0xffffff });
            const upperDoorGeometry = new THREE.BoxGeometry(0.1, 1.5, 2.4);
            const thanhdoorGeometry = new THREE.BoxGeometry(0.1, 1.5, 0.1);
            const lowerDoorGeometry = new THREE.BoxGeometry(0.1, 1.5, 2.4);
            const handleGeometry = new THREE.BoxGeometry(0.05, 0.2, 0.4);
            const handleMaterial = new THREE.MeshPhongMaterial({ color: 0x000000 });


            // ======== Cửa trên trái ========
            leftUpperDoorGroup = new THREE.Group();
            const leftUpperDoor = new THREE.Mesh(upperDoorGeometry, doorMaterial);
            leftUpperDoor.position.set(0, 0, -1.25); // dịch ra khỏi bản lề
            //trục cửa
            const thanhleftUpperDoor = new THREE.Mesh(thanhdoorGeometry, thanhdoorMaterial);
            thanhleftUpperDoor.position.set(0, 0, 0); // bản lề ở phía ngoài
            //tay nắm cửa
            const leftUpperHandle = new THREE.Mesh(handleGeometry, handleMaterial);
            leftUpperHandle.position.set(0.1, 0.5, -0.8); // đặt trên cửa
            leftUpperDoor.add(leftUpperHandle);
            leftUpperDoorGroup.add(thanhleftUpperDoor, leftUpperDoor);
            leftUpperDoorGroup.position.set(2.4, 1.75, 2.75);
            doorGroup.add(leftUpperDoorGroup);

            // ======== Cửa trên phải ========
            rightUpperDoorGroup = new THREE.Group();
            const rightUpperDoor = new THREE.Mesh(upperDoorGeometry, doorMaterial);
            rightUpperDoor.position.set(0, 0, -1.25);
            const thanhrightUpperDoor = new THREE.Mesh(thanhdoorGeometry, thanhdoorMaterial);
            thanhrightUpperDoor.position.set(0, 0, 0);
            const rightUpperHandle = new THREE.Mesh(handleGeometry, handleMaterial);
            rightUpperHandle.position.set(-0.1, 0.5, -0.8);
            rightUpperDoor.add(rightUpperHandle);
            rightUpperDoorGroup.add(thanhrightUpperDoor, rightUpperDoor);
            rightUpperDoorGroup.position.set(-2.4, 1.75, 2.75);
            doorGroup.add(rightUpperDoorGroup);

            // ======== Cửa dưới trái ========
            leftLowerDoorGroup = new THREE.Group();
            const leftLowerDoor = new THREE.Mesh(lowerDoorGeometry, doorMaterial);
            leftLowerDoor.position.set(0, 0, -1.25);
            const thanhleftLowerDoor = new THREE.Mesh(thanhdoorGeometry, thanhdoorMaterial);
            thanhleftLowerDoor.position.set(0, 0, 0);
            const leftLowerHandle = new THREE.Mesh(handleGeometry, handleMaterial);
            leftLowerHandle.position.set(0.1, 0.5, -0.8);
            leftLowerDoor.add(leftLowerHandle);
            leftLowerDoorGroup.add(thanhleftLowerDoor, leftLowerDoor);
            leftLowerDoorGroup.position.set(2.4, 1.75, 0.25);
            doorGroup.add(leftLowerDoorGroup);

            // ======== Cửa dưới phải ========
            rightLowerDoorGroup = new THREE.Group();
            const rightLowerDoor = new THREE.Mesh(lowerDoorGeometry, doorMaterial);
            rightLowerDoor.position.set(0, 0, -1.25);
            const thanhrightLowerDoor = new THREE.Mesh(thanhdoorGeometry, thanhdoorMaterial);
            thanhrightLowerDoor.position.set(0, 0, 0);
            const rightLowerHandle = new THREE.Mesh(handleGeometry, handleMaterial);
            rightLowerHandle.position.set(-0.1, 0.5, -0.8);
            rightLowerDoor.add(rightLowerHandle);
            rightLowerDoorGroup.add(thanhrightLowerDoor, rightLowerDoor);
            rightLowerDoorGroup.position.set(-2.4, 1.75, 0.25);
            doorGroup.add(rightLowerDoorGroup);

            car.add(doorGroup);
        }

    let frontWheels = []; // [{ pivot, wheelGroup }]
    let rearWheels = [];  // [wheelGroup]

    function createWheels() {
        const wheelGeometry = new THREE.CylinderGeometry(1, 1, 0.3, 16);
        const wheelMaterial = new THREE.MeshPhongMaterial({ color: 0x333333 });

        const barGeometry1 = new THREE.BoxGeometry(0.4, 1, 0.2);
        const barGeometry2 = new THREE.BoxGeometry(0.4, 0.2, 1);
        const barMaterial = new THREE.MeshPhongMaterial({ color: 0xffffff });

        const wheelPositions = [
            { x: -2.7, z: 3.8, isFront: true },   // front-right
            { x:  2.7, z: 3.8, isFront: true },   // front-left
            { x: -2.7, z: -3.2, isFront: false }, // rear-right
            { x:  2.7, z: -3.2, isFront: false }  // rear-left
        ];

        wheelPositions.forEach(pos => {
            if (pos.isFront) {
                // --- Pivot: quay theo góc lái ---
                const pivot = new THREE.Object3D();
                pivot.position.set(pos.x, 1, pos.z);
                car.add(pivot);

                // --- Wheel mesh (quay lăn) ---
                const wheel = new THREE.Mesh(wheelGeometry, wheelMaterial);
                wheel.rotation.z = Math.PI / 2;
                wheel.castShadow = true;
                wheel.receiveShadow = true;

                // --- Thanh gắn bánh xe ---
                const bar1 = new THREE.Mesh(barGeometry1, barMaterial);
                const bar2 = new THREE.Mesh(barGeometry2, barMaterial);
                bar1.castShadow = bar2.castShadow = true;
                bar1.receiveShadow = bar2.receiveShadow = true;

                const wheelGroup = new THREE.Group();
                wheelGroup.add(wheel);
                wheelGroup.add(bar1);
                wheelGroup.add(bar2);

                pivot.add(wheelGroup); // Gắn group bánh xe vào pivot

                // Lưu để điều khiển sau
                frontWheels.push({ pivot, wheelGroup });

            } else {
                // --- Bánh sau không cần pivot ---
                const wheel = new THREE.Mesh(wheelGeometry, wheelMaterial);
                wheel.rotation.z = Math.PI / 2;
                wheel.position.set(0, 0, 0);
                wheel.castShadow = true;
                wheel.receiveShadow = true;

                // --- Thanh gắn bánh xe ---
                const bar1 = new THREE.Mesh(barGeometry1, barMaterial);
                const bar2 = new THREE.Mesh(barGeometry2, barMaterial);
                bar1.castShadow = bar2.castShadow = true;
                bar1.receiveShadow = bar2.receiveShadow = true;

                const wheelGroup = new THREE.Group();
                wheelGroup.add(wheel);
                wheelGroup.add(bar1);
                wheelGroup.add(bar2);
                wheelGroup.position.set(pos.x, 1, pos.z);

                car.add(wheelGroup);

                // Lưu để quay bánh
                rearWheels.push(wheelGroup);
            }
        });
    }


    let frontLightLeft, frontLightRight, frontPointLightLeft, frontPointLightRight, trueLightLeftPivot, trueLightRightPivot;
    let rearLightLeft, rearLightRight;
    let lightsOn = false;
    let coneLeft, coneRight;
    let mornitorLight;

    function createHeadlights() {
        const headlightGeometry = new THREE.BoxGeometry(0.6, 0.4, 0.1);
        const headlightMaterial = new THREE.MeshPhongMaterial({ color: 0xffff00 });

        const taillightGeometry = new THREE.BoxGeometry(0.3, 0.3, 0.1);
        const taillightMaterial = new THREE.MeshPhongMaterial({ color: 0xff0000 });

        //vật cản phía trước
        const vatcan = new THREE.Mesh(new THREE.BoxGeometry(10, 10, 0.1), headlightMaterial);
        vatcan.position.set(0, 0, 20);
        vatcan.receiveShadow = true;
        scene.add(vatcan);
        const vatcan2 = new THREE.Mesh(new THREE.BoxGeometry(5, 5, 0.1), headlightMaterial);
        vatcan2.position.set(0, 0, 15);
        vatcan2.castShadow = true;
        scene.add(vatcan2);
        // === Đèn pha (phía trước) ===
        const headlightLeft = new THREE.Mesh(headlightGeometry, headlightMaterial);
        headlightLeft.position.set(-1.2, 1.5, 6.4);
        car.add(headlightLeft);

        const headlightRight = new THREE.Mesh(headlightGeometry, headlightMaterial);
        headlightRight.position.set(1.2, 1.5, 6.4);
        car.add(headlightRight);

        // Thêm đèn thật (ánh sáng vàng)
        frontLightLeft = new THREE.SpotLight(0xffffcc, 0, 16, Math.PI / 7, 0.3);
        frontLightLeft.position.set(0, 0, 0);
        frontLightLeft.target.position.set(0, 0, 16); // chiếu xa hơn
        car.add(frontLightLeft);
        car.add(frontLightLeft.target);
        frontLightLeft.castShadow = true;
        frontLightLeft.target.updateMatrixWorld();

        trueLightLeftPivot = new THREE.Object3D();
        trueLightLeftPivot.position.set(0, 0, 0);
        trueLightLeftPivot.add(frontLightLeft);
        trueLightLeftPivot.add(frontLightLeft.target);
        car.add(trueLightLeftPivot);
        trueLightLeftPivot.position.set(-1.2, 1.5, 6.3); 

        frontLightRight = new THREE.SpotLight(0xffffcc, 0, 16, Math.PI / 7, 0.3);
        frontLightRight.position.set(0, 0, 0);
        frontLightRight.target.position.set(0, 0, 16);
        car.add(frontLightRight);
        car.add(frontLightRight.target); 
        frontLightRight.castShadow = true;
        frontLightRight.target.updateMatrixWorld();

        trueLightRightPivot = new THREE.Object3D();
        trueLightRightPivot.position.set(0, 0, 0);
        trueLightRightPivot.add(frontLightRight);
        trueLightRightPivot.add(frontLightRight.target);
        car.add(trueLightRightPivot);
        trueLightRightPivot.position.set(1.2, 1.5, 6.3); 

        // Thêm đèn của oto phía trước phát sáng
        frontPointLightLeft = new THREE.PointLight(0xffffcc, 0, 5);
        frontPointLightLeft.position.set(-1.2, 1.5, 6.5);
        car.add(frontPointLightLeft);

        frontPointLightRight = new THREE.PointLight(0xffffcc, 0, 5);
        frontPointLightRight.position.set(1.2, 1.5, 6.5);
        car.add(frontPointLightRight);
        // Hình nón giả đèn
        coneLeft = createVolumetricBeam(-1.2, 1.5, 13);  // trái
        coneRight = createVolumetricBeam(1.2, 1.5, 13);   // phải
        coneLeft.visible = false;
        coneRight.visible = false;
        

        // === Đèn hậu (phía sau) ===
        const taillightLeft = new THREE.Mesh(taillightGeometry, taillightMaterial);
        taillightLeft.position.set(-1.2, 1.5, -5.8);
        car.add(taillightLeft);

        const taillightRight = new THREE.Mesh(taillightGeometry, taillightMaterial);
        taillightRight.position.set(1.2, 1.5, -5.8);
        car.add(taillightRight);

        // Thêm đèn đỏ phía sau phát sáng
        rearLightLeft = new THREE.PointLight(0xff0000, 0, 5);
        rearLightLeft.position.set(-1.2, 1.5, -7.9);
        car.add(rearLightLeft);

        rearLightRight = new THREE.PointLight(0xff0000, 0, 5);
        rearLightRight.position.set(1.2, 1.5, -7.9);
        car.add(rearLightRight);

        // Thêm đèn từ car mornitor
        mornitorLight = new THREE.PointLight(0xffffcc, 0, 5);
        mornitorLight.position.set(-0.1, 2.3, 2.0);
        car.add(mornitorLight);
    }
        function createVolumetricBeam(x, y, z) {
        const coneGeometry = new THREE.ConeGeometry(7, 16, 64, 1, true); // height = 16
        const coneMaterial = new THREE.MeshBasicMaterial({
            color: 0xffffaa,
            transparent: true,
            opacity: 0.3,
            side: THREE.DoubleSide,
            depthWrite: false,
        });

        const cone = new THREE.Mesh(coneGeometry, coneMaterial);

        // ✅ Dịch cone lên để đỉnh nằm tại gốc toạ độ
        cone.position.z = 16 / 2;

        // ✅ Gán hướng ban đầu quay lên Z+
        cone.quaternion.setFromAxisAngle(new THREE.Vector3(1, 0, 0), -Math.PI / 2);

        // ✅ Tạo pivot group tại đỉnh
        const conePivot = new THREE.Object3D();
        conePivot.position.set(x, y, z-6.8);
        conePivot.add(cone);

        car.add(conePivot);

        return conePivot;  // Trả về pivot chứ không phải cone nữa!
    }




   function createInterior() {
    const material = new THREE.MeshPhongMaterial({ color: 0xffffff });

    // Danh sách vị trí ghế
    const chairPositions = [
        { x: -1, z: 1 },   // front-right
        { x: 1, z: 1 },    // front-left
        { x: -1, z: -1.3 },  // rear-right
        { x: 1, z: -1.3 }    // rear-left
    ];

    chairPositions.forEach(pos => {
        const chair = new THREE.Group(); // Tạo ghế mới cho mỗi vị trí

        // Mặt ghế (ngang)
        const seatGeometry = new THREE.BoxGeometry(1.5, 0.8, 1.6);
        const seat = new THREE.Mesh(seatGeometry, material);
        seat.position.set(0, 0.5, 0); // vì cao 0.5 nên nâng lên 0.25
        chair.add(seat);

        // Lưng ghế (đứng)
        const backGeometry = new THREE.BoxGeometry(1.5, 2, 0.2);
        const back = new THREE.Mesh(backGeometry, material);
        back.position.set(0, 1.25, -0.7); // đứng lên từ mặt ghế
        chair.add(back);

        // Đặt vị trí toàn bộ ghế trong xe
        chair.position.set(pos.x, 1, pos.z);

        // Thêm vào xe hoặc scene
        car.add(chair); // hoặc scene.add(chair) nếu dùng ngoài xe
    });

        // Vô lăng
        steeringGroup = new THREE.Group();
        const darkMaterial = new THREE.MeshPhongMaterial({ color: 0x333333 });
        const whiteMaterial = new THREE.MeshPhongMaterial({ color: 0xffffff });

        // 1. Trục giữa (trụ đứng)
        const shaftGeometry = new THREE.CylinderGeometry(0.1, 0.1, 0.5, 16);
        const shaft = new THREE.Mesh(shaftGeometry, darkMaterial);
        shaft.position.set(0, 0.2, 0); // nối từ bảng điều khiển ra
        steeringGroup.add(shaft);

        // 2. Tay nắm chính (trụ dẹt, rộng hơn trục)
        const hubGeometry = new THREE.CylinderGeometry(0.2, 0.2, 0.1, 16);
        const hub = new THREE.Mesh(hubGeometry, whiteMaterial);
        hub.position.set(0, 0.5, 0); // đặt ở đầu trục
        steeringGroup.add(hub);

        // 3. 3 thanh nan nối từ tâm ra ngoài (dạng dấu sao)
        const spoke1 = new THREE.Mesh(
            new THREE.BoxGeometry(0.5, 0.05, 0.05),
            new THREE.MeshPhongMaterial({ color: 0x00ff00 }) // xanh lá
        );
        spoke1.position.set(Math.cos((30 * Math.PI) / 180) * 0.25, 0.5, Math.sin((30 * Math.PI) / 180) * 0.25); // nửa chiều dài
        spoke1.rotation.y = -(30 * Math.PI) / 180;
        steeringGroup.add(spoke1);

        // Thanh 2 – hướng 120 độ
        const angle2 = (150 * Math.PI) / 180;
        const spoke2 = new THREE.Mesh(
            new THREE.BoxGeometry(0.5, 0.05, 0.05),
            new THREE.MeshPhongMaterial({ color: 0x00ff00 }) // xanh lá
        );
        spoke2.position.set(Math.cos(angle2) * 0.25, 0.5, Math.sin(angle2) * 0.25);
        spoke2.rotation.y = -angle2;
        steeringGroup.add(spoke2);

        // Thanh 3 – hướng 240 độ
        const angle3 = (270 * Math.PI) / 180;
        const spoke3 = new THREE.Mesh(
            new THREE.BoxGeometry(0.5, 0.05, 0.05),
            new THREE.MeshPhongMaterial({ color: 0xffffff }) // xanh dương
        );
        spoke3.position.set(Math.cos(angle3) * 0.25, 0.5, Math.sin(angle3) * 0.25);
        spoke3.rotation.y = -angle3;
        steeringGroup.add(spoke3);


        // 4. Vành ngoài (vòng tròn rỗng)
        const torusGeometry = new THREE.TorusGeometry(0.5, 0.05, 16, 100);
        const torus = new THREE.Mesh(torusGeometry, darkMaterial);
        torus.rotation.x = Math.PI / 2;
        torus.position.y = 0.5;
        steeringGroup.add(torus);

        // Đặt vô lăng đúng vị trí trong xe nếu muốn
        steeringGroup.position.set(1, 2, 2.7); // điều chỉnh tùy xe bạn
        steeringGroup.rotation.x = -Math.PI / 3;
        car.add(steeringGroup); // hoặc scene.add nếu muốn test riêng
        // Bảng điều khiển

        const MornitorGeometry = new THREE.BoxGeometry(1.1, 0.6, 0.1);
        const textureLoader = new THREE.TextureLoader();
        textureLoader.load('car_monitor.jpg', function(plateTexture) {
            // Tạo 6 mặt vật liệu, chỉ mặt trước là có texture
            const materials = [
                new THREE.MeshPhongMaterial({ color: 0x000000 }), // Right
                new THREE.MeshPhongMaterial({ color: 0x000000 }), // Left
                new THREE.MeshPhongMaterial({ color: 0x000000 }), // Top
                new THREE.MeshPhongMaterial({ color: 0x000000  }), // Bottom
                new THREE.MeshPhongMaterial({ color: 0x000000 }), // Front – biển số
                new THREE.MeshPhongMaterial({ map: plateTexture })  // Back
            ];

            const Mornitor = new THREE.Mesh(MornitorGeometry, materials);
            Mornitor.position.set(-0.1, 2.2, 2.5); 
            Mornitor.rotation.x = Math.PI / 4;
            car.add(Mornitor);
        });

}       

        function createWindshield() {
            
            // Kính chắn gió trước
            const windshieldgroup = new THREE.Group();
            const doorMaterial = new THREE.MeshPhongMaterial({ color: 0x0066cc });

            // Vật liệu phần kính cửa (trong suốt nhẹ)
            const glassMaterial = new THREE.MeshPhongMaterial({
                color: 0x99ccff,
                transparent: true,
                opacity: 0.2
            });

            // Kích thước phần dưới và phần trên
            const wsGeometry = new THREE.BoxGeometry(4.5, 2, 0.1); // thân dưới
            const k1Geometry = new THREE.BoxGeometry(0.1, 2, 0.1); // thân dưới

            const windshield = new THREE.Mesh(wsGeometry, glassMaterial);
            windshield.position.set(0, 0, 0);
            windshield.castShadow = true;


            const k1 = new THREE.Mesh(k1Geometry, doorMaterial)
            const k2 = new THREE.Mesh(k1Geometry, doorMaterial)
            k1.position.set(2.25,0,0);
            k2.position.set(-2.25,0,0);

            windshieldgroup.add( windshield, k1, k2);
            windshieldgroup.position.set(0,3.1,2.8);
            windshieldgroup.rotation.x = -Math.PI/4;
            car.add(windshieldgroup);
        }
        function createLicencePlate() {
            const licencePlateGeometry = new THREE.BoxGeometry(1.7, 0.6, 0.1);
            const textureLoader = new THREE.TextureLoader();
            textureLoader.load('licence_plate.jpg', function(plateTexture) {
                // Tạo 6 mặt vật liệu, chỉ mặt trước là có texture
                const materials = [
                    new THREE.MeshPhongMaterial({ color: 0x000000 }), // Right
                    new THREE.MeshPhongMaterial({ color: 0x000000 }), // Left
                    new THREE.MeshPhongMaterial({ color: 0x000000 }), // Top
                    new THREE.MeshPhongMaterial({ color: 0x000000  }), // Bottom
                    new THREE.MeshPhongMaterial({ color: 0x000000 }), // Front – biển số
                    new THREE.MeshPhongMaterial({ map: plateTexture })  // Back
                ];

                const licencePlate = new THREE.Mesh(licencePlateGeometry, materials);
                licencePlate.position.set(0, 1.5, -5.8); 
                car.add(licencePlate);
            });
        }

        function changeView() {
            if (isThirdPerson) {
                setFirstPersonView();
            } else {
                setThirdPersonView();
            }
            isThirdPerson = !isThirdPerson;
        }

        function addEventListeners() {
            renderer.domElement.addEventListener('mousedown', onMouseDown);
            renderer.domElement.addEventListener('mousemove', onMouseMove);
            renderer.domElement.addEventListener('mouseup', onMouseUp);
            renderer.domElement.addEventListener('wheel', onMouseWheel);
            window.addEventListener('resize', onWindowResize);
            document.addEventListener('keydown', (event) => {
                switch (event.key) {
                    case 'w': moveForward = true; break;
                    case 's': moveBackward = true; break;
                    case 'a': turnLeft = true; break;
                    case 'd': turnRight = true; break;
                }
                });
            document.addEventListener('keyup', (event) => {
                switch (event.key) {
                    case 'w': moveForward = false; break;
                    case 's': moveBackward = false; break;
                    case 'a': turnLeft = false; break;
                    case 'd': turnRight = false; break;
                }
            });
        }

        function onMouseDown(event) {
            isMouseDown = true;
            mouseX = event.clientX;
            mouseY = event.clientY;
        }

        function onMouseMove(event) {
            if (!isMouseDown) return;

            const deltaX = event.clientX - mouseX;
            const deltaY = event.clientY - mouseY;

            
                const spherical = new THREE.Spherical();
                spherical.setFromVector3(camera.position);
                spherical.theta -= deltaX * 0.01;
                spherical.phi -= deltaY * 0.01;
                spherical.phi = Math.max(0.1, Math.min(Math.PI - 0.1, spherical.phi));
                camera.position.setFromSpherical(spherical);
                camera.lookAt(0, 0, 0);
            

            mouseX = event.clientX;
            mouseY = event.clientY;
        }

        function onMouseUp() {
            isMouseDown = false;
        }

        function onMouseWheel(event) {
            const distance = camera.position.distanceTo(new THREE.Vector3(0, 0, 0));
            const factor = event.deltaY > 0 ? 1.1 : 0.9;
            
            if (distance * factor > 2 && distance * factor < 50) {
                camera.position.multiplyScalar(factor);
            }
        }


        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            handleSteering(); // hàm nhận input từ A/D để gọi updateSteering()
            quayVoLang();// quay vô lăng
            updateMovement();      // xử lý hướng và tốc độ
            updateStatusDisplay();
            helperLeft.update();   // cập nhật hướng ánh sáng
            helperRight.update();
            renderer.render(scene, camera);
            requestAnimationFrame(animate);
        }
        function TurnOnOffLight() {
            lightsOn = !lightsOn;

            frontLightLeft.intensity = lightsOn ? 10 : 0;
            frontLightRight.intensity = lightsOn ? 10 : 0;
            frontPointLightLeft.intensity=lightsOn? 5 : 0;
            frontPointLightRight.intensity=lightsOn? 5 : 0;
            rearLightLeft.intensity = lightsOn ? 1.5 : 0;
            rearLightRight.intensity = lightsOn ? 1.5 : 0;
            // Ẩn/Hiện cone ánh sáng
            coneLeft.visible = lightsOn;
            coneRight.visible = lightsOn;
            //ánh sáng từ car mornitor
            mornitorLight.intensity = lightsOn ? 1.5 : 0;
        }

        function TurnOnOffSun() {
            sunon = !sunon; // Chuyển trạng thái bật/tắt ánh sáng

            // Nếu bật ánh sáng
            if (sunon) {
                ambientLight.intensity = 0.6; // Bật ánh sáng môi trường
                directionalLight.intensity = 0.8; // Bật ánh sáng hướng
            } else {
                ambientLight.intensity = 0; // Tắt ánh sáng môi trường
                directionalLight.intensity = 0; // Tắt ánh sáng hướng
            }
        }

        function toggleAllDoors() {
            const angle = THREE.MathUtils.degToRad(60);
            if (!doorUpperLeftOpen) {
                gsap.to(leftUpperDoorGroup.rotation, { y: -angle, duration: 1 });
            } else {
                gsap.to(leftUpperDoorGroup.rotation, { y: 0, duration: 1 });
            }
            doorUpperLeftOpen = !doorUpperLeftOpen;
            if (!doorUpperRightOpen) {
                gsap.to(rightUpperDoorGroup.rotation, { y: angle, duration: 1 });
            } else {
                gsap.to(rightUpperDoorGroup.rotation, { y: 0, duration: 1 });
            }
            doorUpperRightOpen = !doorUpperRightOpen;
            if (!doorLowerLeftOpen) {
                gsap.to(leftLowerDoorGroup.rotation, { y: -angle, duration: 1 });
            } else {
                gsap.to(leftLowerDoorGroup.rotation, { y: 0, duration: 1 });
            }
            doorLowerLeftOpen = !doorLowerLeftOpen;
            if (!doorLowerRightOpen) {
                gsap.to(rightLowerDoorGroup.rotation, { y: angle, duration: 1 });
            } else {
                gsap.to(rightLowerDoorGroup.rotation, { y: 0, duration: 1 });
            }
            doorLowerRightOpen = !doorLowerRightOpen;
        }
        function toggleDoorUpperLeft() {
            const angle = THREE.MathUtils.degToRad(60);
            if (!doorUpperLeftOpen) {
                gsap.to(leftUpperDoorGroup.rotation, { y: -angle, duration: 1 });
            } else {
                gsap.to(leftUpperDoorGroup.rotation, { y: 0, duration: 1 });
            }
            doorUpperLeftOpen = !doorUpperLeftOpen;
        }
        function toggleDoorUpperRight() {
            const angle = THREE.MathUtils.degToRad(60);
            if (!doorUpperRightOpen) {
                gsap.to(rightUpperDoorGroup.rotation, { y: angle, duration: 1 });
            } else {
                gsap.to(rightUpperDoorGroup.rotation, { y: 0, duration: 1 });
            }
            doorUpperRightOpen = !doorUpperRightOpen;
        }
        function toggleDoorLowerLeft() {
            const angle = THREE.MathUtils.degToRad(60);
            if (!doorLowerLeftOpen) {
                gsap.to(leftLowerDoorGroup.rotation, { y: -angle, duration: 1 });
            } else {
                gsap.to(leftLowerDoorGroup.rotation, { y: 0, duration: 1 });
            }
            doorLowerLeftOpen = !doorLowerLeftOpen;
        }
        function toggleDoorLowerRight() {
            const angle = THREE.MathUtils.degToRad(60);
            if (!doorLowerRightOpen) {
                gsap.to(rightLowerDoorGroup.rotation, { y: angle, duration: 1 });
            } else {
                gsap.to(rightLowerDoorGroup.rotation, { y: 0, duration: 1 });
            }
            doorLowerRightOpen = !doorLowerRightOpen;
        }
        function quayVoLang() {
            steeringGroup.rotation.y = steeringAngle; 
            // Đặt dấu '-' nếu cần quay ngược để phù hợp thực tế
        }


        function handleSteering() {
            const steerSpeed = 0.02;
            if (turnLeft && !turnRight) {
                updateSteering(steerSpeed);
            } else if (turnRight && !turnLeft) {
                updateSteering(-steerSpeed);
            }
            // Nếu cả hai cùng true hoặc đều false → không thay đổi gì
        }
        function updateSteering(deltaAngle) {
            steeringAngle = THREE.MathUtils.clamp(
                steeringAngle + deltaAngle,
                -maxSteeringAngle,
                maxSteeringAngle
            );

            // cập nhật bánh trước quay theo 1/3 góc vô lăng
            const wheelAngle = steeringAngle / 3;
            frontWheels.forEach(({ pivot }) => {
                pivot.rotation.y = wheelAngle; // Bẻ trái/phải
            });
            //quay đèn
            trueLightLeftPivot.rotation.y=wheelAngle;
            trueLightRightPivot.rotation.y=wheelAngle;

            coneLeft.rotation.y = wheelAngle;
            coneRight.rotation.y = wheelAngle;

            

        }
        function updateMovement() {
            // Tăng tốc khi nhấn W hoặc S
            if (moveForward) {
                velocity = Math.min(velocity + acceleration, maxSpeed);
            } else if (moveBackward) {
                velocity = Math.max(velocity - acceleration, -maxSpeed / 2); // Lùi chậm hơn tiến
            } else {
                // Nếu không nhấn gì, tự giảm tốc
                if (velocity > 0) {
                    velocity = Math.max(velocity - deceleration, 0);
                } else if (velocity < 0) {
                    velocity = Math.min(velocity + deceleration, 0);
                }
            }

            // Lấy hướng di chuyển dựa trên góc vô lăng
            const wheelDirection = new THREE.Vector3(0, 0, 1);
            const wheelAngle = steeringAngle / 3;
            wheelDirection.applyAxisAngle(new THREE.Vector3(0, 1, 0), car.rotation.y + wheelAngle);
            wheelDirection.normalize();

            // Cập nhật vị trí xe (có thể tiến hoặc lùi)
            car.position.add(wheelDirection.multiplyScalar(velocity));

            // Cập nhật hướng quay (chỉ xoay khi đang di chuyển)
            if (velocity !== 0) {
                const direction = velocity > 0 ? 1 : -1;
                car.rotation.y += direction * Math.tan(wheelAngle) * Math.abs(velocity) * 0.05;
            }
            //  Tính khoảng cách di chuyển (giả lập quay bánh xe)
            const distance = velocity; // đơn vị di chuyển
            const wheelCircumference = 2 * Math.PI * 1; // radius = 1
            wheelRotation += distance / wheelCircumference * 2 * Math.PI;

            frontWheels.forEach(({ wheelGroup }) => {
                wheelGroup.rotation.x = wheelRotation;
            });
            rearWheels.forEach(wheelGroup => {
                wheelGroup.rotation.x = wheelRotation;
            });

        }
        function updateStatusDisplay() {
            document.getElementById("steeringAngle").textContent = steeringAngle.toFixed(2);
            document.getElementById("velocity").textContent = velocity.toFixed(2);
            document.getElementById("forward").textContent = moveForward;
            document.getElementById("backward").textContent = moveBackward;
            document.getElementById("left").textContent = turnLeft;
            document.getElementById("right").textContent = turnRight;
        }


        // Khởi động ứng dụng
        init();
    </script>
</body>
</html>